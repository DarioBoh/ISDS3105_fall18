---
title: "ISDS 3105 mid-term Exam"
author: "Dario Bonaretti"
date: "2/24/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message=FALSE}
#I muted the messages for readability, althought it is not explicitly required
library(tidyverse)
```


```{r}
load('employeesBR.RData')
```

```{r}
dt <- left_join(x = dt, y= lkt, by = c('division_num'='division_num'))
```

##Introduction

This is my analysis for **Baton Rouge** for year *2016*.

##Data Inspection

```{r}
#dt %>% distinct(department_name) %>% nrow
#length(unique(dt$department_name))
```

There are a total of `r length(unique(dt$department_name))` departments in this dataset.

```{r}
employeesCount <- dt %>% group_by(department_name) %>% summarise(count = n())

hh <- employeesCount %>% arrange(desc(count))
```

The unique department names are: `r hh$department_name`

```{r}
hh <- employeesCount %>% 
          filter(department_name == 'MOSQUITO & RODENT CONTROL')
```

The total number for MOSQUITO & RODENT CONTROL is `r hh$count`

##Data Preparation


```{r}
dt <- dt %>% 
          filter(department_name != 'COUNCIL ADMINISTRATOR')
#another way to negate an equality test filter(!(department_name == 'COUNCIL ADMINISTRATOR'))
```

```{r}
retir <- dt %>% select(department_name, end_date) %>% mutate(retirement = !is.na(end_date)) %>% 
  count(department_name, retirement)
```


```{r}
retir %>% 
  group_by(department_name) %>% 
  mutate(totEmplyees = sum(n)) %>% 
  filter(retirement == T) %>% 
  mutate(perc = n/totEmplyees) 
#if you wish, you may pipe a knitr::kable() to your tables to knit using a more readable layout. But you need to install "knitr" first.
```


```{r}
hh <- retir %>% group_by(retirement) %>% summarise(tot = sum(n))
```

The toal employees who retired are `r filter(hh, retirement == T) %>% select(tot)` those who did not `r filter(hh, retirement == F) %>% select(tot)`

##Data Visualization

```{r}
ggplot(data = retir ) +
  geom_col(aes(x = department_name, y = n, fill = retirement)) +
  ggtitle('Count of retirements', '2016') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
salary <- dt %>% group_by(department_name) %>% summarise(avg=mean(base_pay)) %>% 
  arrange(desc(avg))
# filter(salary, avg == max(avg)) this solution is superior because it gives you the right result even if you fail arranging
# slice(salary, 1)
# salary[1,]
```

The department that pays the most is: `r  filter(salary, avg == max(avg))`

##Data Analysis

```{r}
salary %>% arrange(desc(avg)) %>% slice(1:10)  
#salary %>% arrange(desc(avg)) %>% top_n(10)
#both solutions are acceptable in this case but note the diff between:
# data_frame(var1 = rep(10, 10)) %>% top_n(2)
# data_frame(var1 = rep(10, 10)) %>% slice(1:2)
```

```{r}
dt %>% select(department_name, overtime_hourly_rate, total_overtime_hours) %>% 
  mutate(costOvertime = overtime_hourly_rate*total_overtime_hours) %>% 
  group_by(department_name) %>% 
  summarise(avg = mean(costOvertime)) %>% 
  arrange(desc(avg)) %>% 
  slice(1:3)
```



